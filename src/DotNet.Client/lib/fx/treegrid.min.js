!function(e){"use strict";var t=function(){function t(t,n){this.element=t,this.$element=e(t),this.options=n,this.$treegridEl=this.$element.find(".treegrid"),this.$toolbarEl=this.$element.find(".treegridtoolbar"),this.$tcreaterootEl=this.$toolbarEl.find(".tcreateroot"),this.$tcreateEl=this.$toolbarEl.find(".tcreate"),this.$teditEl=this.$toolbarEl.find(".tedit"),this.$tdeleteEl=this.$toolbarEl.find(".tdelete"),this.$trefreshEl=this.$toolbarEl.find(".trefresh"),this.$menuEl=this.$element.find(".ttmenu"),this.$menuCreateEl=this.$element.find(".ttmcreate"),this.$menuEditEl=this.$element.find(".ttmedit"),this.$menuDeleteEl=this.$element.find(".ttmdelete"),this.$menuRefreshEl=this.$element.find(".ttmrefresh"),this.$tfilterEl=this.$element.find(".tfilter"),this.initToolbar(),this.initTreeGrid(),this.initMenu()}var n,i=function(e,t){for(var n=0;n<e.length;n++)if(e[n]._parentId==t)return!0;return!1},r=function(e){var t=e.$treegridEl.treegrid("getSelected");return t?t:(fx.msg("请先选择节点"),null)};return t.prototype.initTreeGrid=function(){var t=this;t.$treegridEl.treegrid({url:t.$treegridEl.data("url"),fit:!0,border:!1,striped:!0,rownumbers:!0,loadMsg:"正在加载数据...",animate:!0,fitColumns:!0,collapsible:!0,method:"get",toolbar:t.$toolbarEl[0],idField:"Id",treeField:"Name",loadFilter:function(t){return e.each(t.rows,function(e,n){n._parentId&&"0"==n._parentId&&(n._parentId=null),n.IsExpand&&1==n.IsExpand?n.state="open":i(t.rows,n.Id)&&(n.state="closed"),n.iconCls&&(n.iconCls="font-icon-treegrid "+n.iconCls)}),t},onSelect:function(e){t.lastSelectedId=e.Id},onContextMenu:function(n,i){n.preventDefault(),i&&(e(this).treegrid("expand",i.Id),e(this).treegrid("select",i.Id),t.$menuEl.menu("show",{left:n.pageX,top:n.pageY}))},onDblClickRow:function(t){var n=e(this).data("detailsUrl"),i={id:t.Id};fx.window({url:n,data:i})},onDragOver:function(e,t){return t._parentId!=e.Id},onBeforeDrop:function(e,t){n=t._parentId},onDrop:function(i,r,l){var o,d=e(this).data("parentUrl"),a=e(this).data("sortUrl"),s=r.Id;o="append"==l?i.Id:i._parentId,o&&""!=o||(o="0"),e.post(d,{id:s,oldParentId:n,newParentId:o},function(e){e.success||fx.alert(e.message)});var u=[];u.push(o);var c={};e.each(u,function(n,i){var r=t.$treegridEl.treegrid("find",i);if(null==r){var l=t.$treegridEl.treegrid("getRoots");e.each(l,function(e,t){c[t.Id]=fx.fixLenString(e.toString(),4,"0")})}else r.children&&e.each(r.children,function(e,n){c[n.Id]=t.getNodeSortPath(n.Id)})}),e.post(a,c,function(e){e.success||fx.alert(e.message)})},onLoadSuccess:function(){var n=e(this),i=n.treegrid("find",t.lastSelectedId);i&&(n.treegrid("expandTo",i.Id),n.treegrid("select",i.Id)),e(this).treegrid("enableDnd",null)}})},t.prototype.getNodeSortPath=function(e){if(!e)return"";var t=this.$treegridEl.treegrid("getParent",e);if(null!=t){var n=this.getNodeSortPath(t.Id);return n+fx.fixLenString(this.getNodeIndex(e,t.children),4,"0")}return fx.fixLenString(this.getNodeIndex(e,this.$treegridEl.treegrid("getRoots")),4,"0")},t.prototype.getNodeIndex=function(t,n){var i=-1;return e.each(n,function(e,n){if(n.Id==t)return i=e,!1}),i.toString()},t.prototype.initMenu=function(){var t=this;t.$menuEl.length>0&&(t.$menuEl.menu({onShow:function(){var n=r(t);"0"==n.id?(t.$menuEditEl.length>0&&e(this).menu("disableItem",t.$menuEditEl[0]),t.$menuDeleteEl.length>0&&e(this).menu("disableItem",t.$menuDeleteEl[0])):(t.$menuEditEl.length>0&&e(this).menu("enableItem",t.$menuEditEl[0]),t.$menuDeleteEl.length>0&&e(this).menu("enableItem",t.$menuDeleteEl[0]))}}),fx.onModuleDestroy(function(){t.$menuEl.menu("destroy")})),t.$menuCreateEl.length>0&&t.$menuCreateEl.click(function(){var n=e(this).data("url");t.create(n)}),t.$menuEditEl.length>0&&t.$menuEditEl.click(function(){var n=e(this).data("url");t.edit(n)}),t.$menuDeleteEl.length>0&&t.$menuDeleteEl.click(function(){var n=e(this).data("url");t["delete"](n)}),t.$menuRefreshEl.length>0&&t.$menuRefreshEl.click(function(){t.refresh()})},t.prototype.initToolbar=function(){var t=this;t.$tcreaterootEl.length>0&&t.$tcreaterootEl.click(function(){var n=e(this).data("url");t.createRoot(n)}),t.$tcreateEl.length>0&&t.$tcreateEl.click(function(){var n=e(this).data("url");t.create(n)}),t.$teditEl.length>0&&t.$teditEl.click(function(){var n=e(this).data("url");t.edit(n)}),t.$tdeleteEl.length>0&&t.$tdeleteEl.click(function(){var n=e(this).data("url");t["delete"](n)}),t.$trefreshEl.length>0&&t.$trefreshEl.click(function(){t.refresh()})},t.prototype.createRoot=function(e){fx.window({url:e,data:{parentid:0}})},t.prototype.create=function(e){var t=this,n=r(t);n&&fx.window({url:e,data:{parentid:n.Id}})},t.prototype.edit=function(e){var t=this,n=r(t);n&&fx.window({url:e,data:{id:n.Id}})},t.prototype["delete"]=function(e){var t=this,n=r(t);n&&fx.ajax({url:e,data:{id:n.Id},confirm:"确定要删除选中的节点以及子节点吗?",success:function(e){e.success?t.refresh():fx.alert(e.message)}})},t.prototype.refresh=function(){this.$treegridEl.treegrid("reload")},t.prototype.setOptions=function(t){"object"==typeof t&&e.extend(this.options,t)},t}();e.fn.uitreegrid=function(n){return this.each(function(){var i=e(this),r=i.data("uitreegrid");r?r.setOptions(n):(r=new t(this,{}),i.data("uitreegrid",r))}),e(this).data("uitreegrid")},e(document).on(fx.initUIEventName,function(t){e(t.target).find(".uitreegrid").uitreegrid()})}(jQuery);