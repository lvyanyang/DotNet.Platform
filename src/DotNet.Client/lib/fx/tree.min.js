!function(t){"use strict";var e=function(){function e(e,n){this.element=e,this.$element=t(e),this.options=n,this.init()}var n=function(t,e){for(var n=0;n<t.length;n++)if(t[n].id==e)return!0;return!1},o=function(t){for(var e=[],o=0;o<t.length;o++){var i=t[o];n(t,i.parentid)||e.push(i)}for(var r=[],o=0;o<e.length;o++)r.push(e[o]);for(;r.length;)for(var s=r.shift(),o=0;o<t.length;o++){var i=t[o];if(i.parentid==s.id){var a=i;s.children?s.children.push(a):s.children=[a],r.push(a)}}return e},i=function(e,n,o,i){var r=e.$element,s=(r.tree("getNode",n).id,o.parentid),a=o.id,l=r.tree("find",a),p=r.tree("getParent",l.target),c=p.id;if(s!=c){var d=r.data("parentUrl");if(d){var u={id:a,newParentId:c};t.post(d,u,function(t){t.message&&alert(t.message)})}}var f=r.data("sortUrl");if(f){var h=r.tree("find",c);if(!h)return void alert("更新节点顺序出错,无效的节点Id");var g={},m=h.children||{};t.each(m,function(t,n){g[n.id]=e.getNodeSortPath(n.id)}),t.post(f,g,function(t){t.message&&alert(t.message)})}},r=function(e,n){var o=[];t.map(t.isArray(e)?e:[e],function(e){e=t.trim(e),e&&o.push(e)});for(var i=0;i<o.length;i++){var r=n.text.toLowerCase().indexOf(o[i].toLowerCase())>=0,s=n.spell&&n.spell.toLowerCase().indexOf(o[i].toLowerCase())>=0;if(r||s)return!0}return!o.length},s=function(t){return t?t.children&&t.children.length>0?t.children[0]:void 0:null};return e.prototype.init=function(){this.options.loadMaskTarget||(this.options.loadMaskTarget=this.element);var t=this;this.options.filter=r;var e=this.options.onBeforeLoad;this.options.onBeforeLoad=function(n,o){fx.loadMask.show(t.options),e&&e.call(this,n,o)};var n=this.options.onLoadSuccess;this.options.onLoadSuccess=function(e,o){fx.loadMask.hide(t.options),n&&n.call(this,e,o)};var s=this.options.onLoadError;this.options.onLoadError=function(e){fx.loadMask.hide(t.options),fx.ajaxFail(e,t.$element),s&&s.call(this,msg)};var a=this.options.loadFilter;this.options.loadFilter=function(e){return a&&a.call(this,e),1==t.options.convert?o(e):e};var l=this.options.onClick;this.options.onClick=function(e){t.options.clickToggle&&t.toggle(e.target),l&&l.call(this,e)};var p=this.options.onDrop;this.options.onDrop=function(e,n,o){p&&p.call(this,e,n,o),i(t,e,n,o)},this.$element.tree(this.options)},e.prototype.setOptions=function(e){"object"==typeof e&&(t.extend(this.options,e),this.init())},e.prototype.getLevelNodeId=function(t){for(var e=1,n=this.getRoot();e<t&&(e++,n=s(n)););return n?n.id:0},e.prototype.getNodeSortPath=function(t){if(!t)return"";var e=this.find(t),n=this.getParent(e.target);if(n){var o="";return"0"!=n.id&&(o=this.getNodeSortPath(n.id)),o+fx.fixLenString(this.getNodeIndex(t,n.children),4,"0")}return fx.fixLenString(this.getNodeIndex(t,this.getRoots()),4,"0")},e.prototype.getNodeIndex=function(e,n){var o=-1;return t.each(n,function(t,n){if(n.id==e)return o=t+1,!1}),o.toString()},e.prototype.expandRoot=function(){var t=this.$element.tree("getRoot");t&&this.$element.tree("expand",t.target)},e.prototype.loadData=function(t){this.$element.tree("loadData",t)},e.prototype.getNode=function(t){return this.$element.tree("getNode",t)},e.prototype.getData=function(t){return this.$element.tree("getData",t)},e.prototype.reload=function(t){this.$element.tree("reload",t)},e.prototype.getRoot=function(t){return this.$element.tree("getRoot",t)},e.prototype.getRoots=function(){return this.$element.tree("getRoots")},e.prototype.getParent=function(t){return this.$element.tree("getParent",t)},e.prototype.getChildren=function(t){return this.$element.tree("getChildren",t)},e.prototype.getChecked=function(t){return this.$element.tree("getChecked",t)},e.prototype.getSelected=function(){return this.$element.tree("getSelected")},e.prototype.isLeaf=function(t){return this.$element.tree("isLeaf",t)},e.prototype.find=function(t){return this.$element.tree("find",t)},e.prototype.select=function(t){this.$element.tree("select",t)},e.prototype.check=function(t){this.$element.tree("check",t)},e.prototype.uncheck=function(t){this.$element.tree("uncheck",t)},e.prototype.collapse=function(t){this.$element.tree("collapse",t)},e.prototype.expand=function(t){this.$element.tree("expand",t)},e.prototype.collapseAll=function(t){this.$element.tree("collapseAll",t)},e.prototype.expandAll=function(t){this.$element.tree("expandAll",t)},e.prototype.expandTo=function(t){this.$element.tree("expandTo",t)},e.prototype.scrollTo=function(t){this.$element.tree("scrollTo",t)},e.prototype.toggle=function(t){this.$element.tree("toggle",t)},e.prototype.append=function(t){this.$element.tree("append",t)},e.prototype.insert=function(t){this.$element.tree("insert",t)},e.prototype.remove=function(t){this.$element.tree("remove",t)},e.prototype.pop=function(t){this.$element.tree("pop",t)},e.prototype.update=function(t){this.$element.tree("update",t)},e.prototype.enableDnd=function(){this.$element.tree("enableDnd")},e.prototype.disableDnd=function(){this.$element.tree("disableDnd")},e.prototype.beginEdit=function(t){this.$element.tree("beginEdit",t)},e.prototype.endEdit=function(t){this.$element.tree("endEdit",t)},e.prototype.cancelEdit=function(t){this.$element.tree("cancelEdit",t)},e.prototype.doFilter=function(t){this.$element.tree("doFilter",t)},e.prototype.filter=function(t){this.$element.tree("doFilter",t)},e}();t.fn.uitree=function(n){return this.each(function(){var o=t(this),i=o.data("uitree");if(i)i.setOptions(n);else{var r=t.extend({},t.fn.uitree.defaults,t.fn.uitree.parseOptions(o),n);i=new e(this,r),o.data("uitree",i)}}),t(this).data("uitree")},t.fn.uitree.parseOptions=function(t){return fx.convertOptionToEvent(t),t.data()},t.fn.uitree.defaults=t.extend({},fx.loadMask.defaults,{container:fx.module,convert:!0,clickToggle:!0,loadMaskMessage:"正在加载数据,请稍等..."}),t(document).on(fx.initUIEventName,function(e){t(e.target).find(".uitree").uitree()})}(jQuery);