!function(e){"use strict";var t=function(){function t(t,n){var i=this;this.element=t,this.$element=e(t),this.options=n,this.$treeEl=this.$element.find(".tttree"),this.$tableEl=this.$element.find(".tttable"),this.$tableCreateEl=this.$element.find(".tttcreate"),this.$menuEl=this.$element.find(".ttmenu"),this.$menuCreateEl=this.$element.find(".ttmcreate"),this.$menuEditEl=this.$element.find(".ttmedit"),this.$menuDeleteEl=this.$element.find(".ttmdelete"),this.$menuRefreshEl=this.$element.find(".ttmrefresh"),this.$tttree_filterEl=this.$element.find(".tttree_filter"),this.$tttree_filterEl.keypress(function(t){13==t.keyCode&&i.$treeEl.tree("doFilter",e(this).val().trim())}),this.initMenu(),this.initTable(),this.initTree();var a=i.$element.data("westWidthName");a&&fx.monitorPanelWidth(a,i.$element,"west")}var n=function(e){var t=e.$treeEl.uitree(),n=t.getSelected();return n?n:(fx.alert(e.$treeEl.data("selectedMessage")||"请先选择树节点"),null)},i=function(e){var t=n(e);e.lastLoadId!=t.id&&e.$tableEl.uitable().search()},a=function(t,n,i){var a=function(a){var l=e(this);if(a.success){n.uimodal().close();var r=t.$treeEl.uitree();1==i?(r.append({parent:r.getSelected().target,data:{id:a.data.id,parentid:a.data.parentId,iconCls:a.data.iconCls,text:a.data.text}}),1==t.$menuCreateEl.data("refreshTable")&&t.$tableEl.uitable().reload()):(r.update({target:r.getSelected().target,iconCls:a.data.iconCls,text:a.data.text}),1==t.$menuEditEl.data("refreshTable")&&t.$tableEl.uitable().reload())}else{var d=l.data("errorEl");if(d){var o=e(e(this).uiform().options.container);o.find(d).html(a.message).show()}else fx.alert(a.message)}};n.find("form").uiform({onSubmitSuccess:a})};return t.prototype.initTree=function(){var t=this;0!=t.$treeEl.length&&t.$treeEl.uitree({onLoadSuccess:function(){var n=e(this).uitree(),i=n.find(t.lastSelectedId);if(!i){var a=t.$treeEl.data("expandLevel")||1,l=n.getLevelNodeId(a);i=n.find(l)}n.expandTo(i.target),n.expand(i.target),n.select(i.target),n.scrollTo(i.target)},onSelect:function(e){t.lastSelectedId=e.id,i(t)},onContextMenu:function(n,i){n.preventDefault(),e(this).tree("expand",i.target),e(this).tree("select",i.target),t.$menuEl.menu("show",{left:n.pageX,top:n.pageY})},onClick:function(t){e(this).tree("expand",t.target)}})},t.prototype.initMenu=function(){var t=this;t.$menuEl.length>0&&(t.$menuEl.menu({onShow:function(){var n=t.$treeEl.uitree(),i=n.getSelected();"0"==i.id?(t.$menuEditEl.length>0&&e(this).menu("disableItem",t.$menuEditEl[0]),t.$menuDeleteEl.length>0&&e(this).menu("disableItem",t.$menuDeleteEl[0])):(t.$menuEditEl.length>0&&e(this).menu("enableItem",t.$menuEditEl[0]),t.$menuDeleteEl.length>0&&e(this).menu("enableItem",t.$menuDeleteEl[0]))}}),fx.onModuleDestroy(function(){t.$menuEl.menu("destroy")})),t.$menuCreateEl.length>0&&(t.$menuCreateEl.data("onBeforeShow",function(e){e.data.parentid=t.$treeEl.uitree().getSelected().id}),t.$menuCreateEl.data("onAfterShow",function(){a(t,e(this),!0)})),t.$menuEditEl.length>0&&(t.$menuEditEl.data("onBeforeShow",function(e){e.data.id=t.$treeEl.uitree().getSelected().id}),t.$menuEditEl.data("onAfterShow",function(){a(t,e(this),!1)})),t.$menuRefreshEl.length>0&&t.$menuRefreshEl.click(function(){t.$treeEl.uitree().reload()})},t.prototype.initTable=function(){var t=this;t.$tableEl.length>0&&t.$tableEl.uitable({onBeforeLoad:function(e){var i=n(t);return!!i&&(e.params.parentid=i.id,void(t.lastLoadId=i.id))},onAfterLoad:function(){t.$element.find(".tsdelete").each(function(){1==e(this).data("refreshTree")&&e(this).data("successCallback",function(){t.$treeEl.uitree().reload()})})}}),t.$tableCreateEl.length>0&&t.$tableCreateEl.data("onBeforeShow",function(e){var i=n(t);return!!i&&void(e.data.parentid=i.id)})},t.prototype.setOptions=function(t){"object"==typeof t&&e.extend(this.options,t)},t}();e.fn.uitreetable=function(n){return this.each(function(){var i=e(this),a=i.data("uitreetable");a?a.setOptions(n):(a=new t(this,{}),i.data("uitreetable",a))}),e(this).data("uitreetable")},e(document).on(fx.initUIEventName,function(t){e(t.target).find(".uitreetable").uitreetable()})}(jQuery);